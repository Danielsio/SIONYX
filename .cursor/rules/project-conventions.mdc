---
description: SIONYX project conventions - release workflow, shell, testing, and architecture rules
alwaysApply: true
---

# SIONYX Project Conventions

## Repository Structure
- `sionyx-web/` -- React web admin dashboard (Firebase Hosting)
- `sionyx-kiosk/` -- PyQt6 kiosk desktop app (PyInstaller + NSIS installer)
- `scripts/` -- Management scripts (Python)

## Shell Environment
- User runs **PowerShell on Windows**. Do NOT use bash syntax.
- No `&&` chaining -- use `;` or separate commands
- No `head`/`tail` -- use `Select-Object -First N` / `Select-Object -Last N`
- Git commit messages: use `$msg = @"..."@` then `git commit -m $msg`

## Versioning Rules
- **Version tags are ONLY for the kiosk app** (e.g., `v2.1.3`)
- **Web app has NO version tags** -- it always deploys the latest pushed code
- Never bump `version.json` manually -- `build.py` handles it

## Kiosk Release Workflow
1. Push all code changes to remote first
2. Run `python build.py --patch` (or `--minor`/`--major`) from `sionyx-kiosk/`
3. The script handles: tests, coverage check, version bump, PyInstaller build, NSIS installer, Firebase Storage upload
4. If coverage drops >0.1%, use `--skip-coverage-check` only if the drop is justified
5. After build.py finishes, commit the updated `version.json` and create an annotated tag
6. Push commit + tag to remote

## Web Release Workflow
1. Build: `npm run build` in `sionyx-web/`
2. Deploy: `firebase deploy --only "hosting,database"` (quotes required for PowerShell)
3. No version bump, no tags

## Testing
- **Web:** Vitest + @testing-library/react. Run with `npx vitest run`
- **Kiosk:** pytest + pytest-qt + pytest-mock. Run with `python -m pytest`
- **Bug fixes follow TDD:** write failing test first, then implement fix, then commit
- Each bug fix gets its own commit with clear explanation

## Firebase
- Realtime Database for app data, rules in `database.rules.json`
- Storage for kiosk installer releases
- Hosting for the web app
- Functions for backend logic (e.g., `resetUserPassword`)

## Code Patterns
- Web state management: Zustand stores
- Web org context: always use `useOrgId()` hook, include `orgId` in `useEffect` deps
- Kiosk singletons: `LocalDatabase`, `FirebaseClient` use `__new__` + `_initialized` guard
- Kiosk tests colocated as `*_test.py` next to source files
