{
  "rules": {
    "public": {
      "latestRelease": {
        ".read": true,
        ".write": false
      }
    },
    "organizations": {
      ".read": false,
      ".write": false,
      
      "$orgId": {
        "users": {
          ".read": "auth != null && root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true",
          ".indexOn": ["isActive", "createdAt", "lastSeen"],
          
          "$userId": {
            ".read": "auth.uid == $userId || root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true",
            ".write": "auth.uid == $userId || root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true",
            
            "isAdmin": {
              ".write": "root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true"
            },
            
            "remainingTime": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "printBalance": {
              ".validate": "newData.isNumber()"
            },
            "forceLogout": {
              ".validate": "newData.isBoolean()"
            },
            "timeExpiresAt": {
              ".validate": "newData.isString() || !newData.exists()"
            }
          }
        },
        
        "packages": {
          ".read": "auth != null && root.child('organizations').child($orgId).child('users').child(auth.uid).exists()",
          ".indexOn": ["isActive", "createdAt"],
          
          "$packageId": {
            ".write": "root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true",
            ".validate": "newData.hasChildren(['name', 'price'])",
            
            "name": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
            },
            "price": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "minutes": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "prints": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "validityDays": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "discountPercent": {
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 100"
            },
            "description": {
              ".validate": "newData.isString() && newData.val().length <= 500"
            },
            "isActive": {
              ".validate": "newData.isBoolean()"
            }
          }
        },
        
        "purchases": {
          ".read": "auth != null && root.child('organizations').child($orgId).child('users').child(auth.uid).exists()",
          ".indexOn": ["userId", "status", "createdAt"],
          
          "$purchaseId": {
            ".read": "data.child('userId').val() == auth.uid || root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true",
            ".write": "(!data.exists() && newData.child('userId').val() == auth.uid) || root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true",
            ".validate": "newData.hasChildren(['userId', 'status', 'createdAt'])",
            
            "userId": {
              ".validate": "newData.isString()"
            },
            "status": {
              ".validate": "newData.isString() && (newData.val() == 'pending' || newData.val() == 'completed' || newData.val() == 'failed' || newData.val() == 'cancelled')"
            },
            "amount": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            }
          }
        },
        
        "messages": {
          ".read": "auth != null && root.child('organizations').child($orgId).child('users').child(auth.uid).exists()",
          ".indexOn": ["toUserId", "timestamp", "read"],

          "$messageId": {
            ".read": "auth != null && (data.child('toUserId').val() == auth.uid || root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true)",
            ".write": "auth != null && ((!data.exists() && root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true) || data.child('toUserId').val() == auth.uid)",
            ".validate": "newData.hasChildren(['toUserId', 'message', 'timestamp'])",

            "read": {
              ".write": "auth != null && (data.parent().child('toUserId').val() == auth.uid || root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true)",
              ".validate": "newData.isBoolean()"
            },

            "readAt": {
              ".write": "auth != null && (data.parent().child('toUserId').val() == auth.uid || root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true)",
              ".validate": "newData.isNumber()"
            },
            
            "message": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 1000"
            },
            
            "toUserId": {
              ".validate": "newData.isString()"
            },
            
            "timestamp": {
              ".validate": "newData.isNumber()"
            }
          }
        },
        
        "computers": {
          ".read": "auth != null && root.child('organizations').child($orgId).child('users').child(auth.uid).exists()",
          ".indexOn": ["isActive", "lastSeen", "computerName"],
          
          "$computerId": {
            ".read": "auth != null && root.child('organizations').child($orgId).child('users').child(auth.uid).exists()",
            ".write": "auth != null && root.child('organizations').child($orgId).child('users').child(auth.uid).exists()",
            
            "userId": {
              ".validate": "newData.isString()"
            },
            "computerName": {
              ".validate": "newData.isString() && newData.val().length <= 100"
            },
            "isActive": {
              ".validate": "newData.isBoolean()"
            },
            "lastSeen": {
              ".validate": "newData.isNumber()"
            }
          }
        },
        
        "metadata": {
          ".read": "auth != null && root.child('organizations').child($orgId).child('users').child(auth.uid).exists()",
          ".write": "root.child('organizations').child($orgId).child('users').child(auth.uid).child('isAdmin').val() === true",
          
          "name": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
          },
          "nedarim_mosad_id": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          "nedarim_api_valid": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          "created_at": {
            ".validate": "newData.isString()"
          },
          "status": {
            ".validate": "newData.isString() && (newData.val() == 'active' || newData.val() == 'inactive' || newData.val() == 'suspended')"
          },
          "blackAndWhitePrice": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "colorPrice": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "admin_phone": {
            ".validate": "newData.isString() && newData.val().length <= 20"
          },
          "admin_email": {
            ".validate": "newData.isString() && newData.val().length <= 100"
          }
        }
      }
    }
  }
}
